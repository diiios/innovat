{% extends 'main/base.html' %}

{% block title %}–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–¥–µ–∏ - {{ idea.name }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ideas.css') }}">
{% endblock %}
{% block activePart1 %} active-part {% endblock %}
{% block activePart2 %} {% endblock %}
{% block activePart3 %} {% endblock %}


{% block content %}
<div class="nav">
  <a href="{{ url_for('main.index') }}">–ì–ª–∞–≤–Ω–∞—è > </a>
  <a href="{{ url_for('idea.open') }}"> –ë–∞–Ω–∫ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫. –í–¥–æ—Ö–Ω–æ–≤–ª—è–µ–º—Å—è –∏–¥–µ—è–º–∏ > </a>
  <a href="#">{{ idea.name }}</a>
</div>
<div class="main-box">
  <br><br>
  <div class="one-idea">
    <div class="pdf-viewer-container pdf-idea-one">

<div class="pdf-viewer-container pdf-idea-one">

  <iframe src="{{ url_for('static', filename='uploads/ideas/files/' ~ idea.file) }}" 
          title="–ü—Ä–æ—Å–º–æ—Ç—Ä PDF: {{ idea.name }}" 
          class="pdf-same-file pdf-viewer-desktop">
    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä PDF.
    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{{ url_for('static', filename='uploads/ideas/files/' ~ idea.file) }}">—Å–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª</a>.
  </iframe>

  <div class="pdf-viewer-mobile">
    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä PDF –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—É–¥–æ–±–µ–Ω.</p>
    <a href="{{ url_for('static', filename='uploads/ideas/files/' ~ idea.file) }}" target="_blank" class="download-btn">
      –û—Ç–∫—Ä—ã—Ç—å PDF –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
    </a>
  </div>

</div>

<style>
.pdf-viewer-container {
  width: 100%;
  max-width: 650px; /* –º–∞–∫—Å–∏–º—É–º –¥–ª—è –ü–ö */
  height: auto; /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è iframe */
  margin: 0 auto;
}

object, iframe {
  width: 100%;
  height: 100%;
  border: none;
}

/* –°–∫—Ä—ã–≤–∞–µ–º –º–æ–±–∞–π–ª –±–ª–æ–∫ –Ω–∞ –ü–ö */
.pdf-viewer-mobile {
  display: none;
}

/* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - —Å–∫—Ä—ã–≤–∞–µ–º iframe, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É */
@media (pointer: coarse) and (max-width: 768px) {
  .pdf-viewer-desktop {
    display: none;
  }
  .pdf-viewer-mobile {
    display: block;
    text-align: center;
    padding: 20px;
  }
}


</style>
    </div>

    <div class="info-idea-one">
      <h2>{{ idea.name }}</h2>
      <p class="description">{{ idea.description }}</p>

            {% if idea.tags %}
      <span><strong>–¢–µ–≥–∏:</strong>
        {% for tag in idea.tags.split(',') %}
          {% if tag.strip() %}  {# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—É—é —Å—Å—ã–ª–∫—É #}
          <span class="tag">#{{ tag.strip() }}</span>
          {% endif %}
        {% endfor %}
      </span>
      {% endif %}

<div class="votes">
            <button class="like-btn" data-id="{{ idea.id }}"><img src="{{ url_for('static', filename='images/like-new.png') }}"></button>
            <span id="likes-{{ idea.id }}" class="votes-score">{{ idea.likes or 0 }}</span> &nbsp;
            <button class="dislike-btn" data-id="{{ idea.id }}"><img src="{{ url_for('static', filename='images/like-new.png') }}"></button>
            <span id="dislikes-{{ idea.id }}" class="votes-score">{{ idea.dislikes or 0 }}</span>
          </div>
<br>
<hr style="width: 100%;border: 0.5px solid rgb(255, 255, 255);">

      <p>
        <strong>–°—Å—ã–ª–∫–∏:</strong> <br>

        {% if idea.links is string %}
          {% for link in idea.links.split(',') %}
            <a href="{{ link.strip() }}" target="_blank" class="link">{{ link.strip() }}</a><br>
          {% endfor %}
        {% else %}
          <p>–°—Å—ã–ª–æ–∫ –Ω–µ—Ç</p>
        {% endif %}

      </p>
    </div>
  </div>

  <div class="under-info">

<div class="under-info-part">
    <div style="margin-top: 10px; text-align: right;">
    <a href="{{ url_for('static', filename='uploads/ideas/files/' ~ idea.file) }}" download class="download-btn">
      üì• –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
    </a>
  </div>
  <div style="margin-top: 10px; text-align: right;">
  <a href="{{ url_for('static', filename='uploads/ideas/files/' ~ idea.file) }}" target="_blank" class="fullscreen-btn">
    <img src="{{ url_for('static', filename='images/open-full.png') }}">
    
  </a>
</div>
</div>

<div class="under-info-part">
<a href="{{ url_for('idea.open') }}">–í –±–∞–Ω–∫ –∏–¥–µ–π</a>
</div>

  </div>
</div>
<br><br>


      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const userVotes = {}; // —Ö—Ä–∞–Ω–∏–º –≥–æ–ª–æ—Å–∞ –ø–æ id –∏–¥–µ–∏: 'like', 'dislike' –∏–ª–∏ null

          document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
              event.stopPropagation();
              const id = btn.dataset.id;
              handleVote(id, 'like', btn);
            });
          });

          document.querySelectorAll('.dislike-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
              event.stopPropagation();
              const id = btn.dataset.id;
              handleVote(id, 'dislike', btn);
            });
          });

          function handleVote(id, type, btn) {
            const likeBtn = document.querySelector(`.like-btn[data-id="${id}"]`);
            const dislikeBtn = document.querySelector(`.dislike-btn[data-id="${id}"]`);

            const currentVote = userVotes[id] || null;

            let action = null;

            if (currentVote === type) {
              // —Å–Ω–∏–º–∞–µ–º –≥–æ–ª–æ—Å
              userVotes[id] = null;
              action = `un${type}`; // 'unlike' –∏–ª–∏ 'undislike'
              btn.classList.remove('active');
              if (type === 'like') {
                dislikeBtn.disabled = false;
              } else {
                likeBtn.disabled = false;
              }
            } else {
              // —Å—Ç–∞–≤–∏–º –≥–æ–ª–æ—Å
              userVotes[id] = type;
              action = type;
              if (type === 'like') {
                likeBtn.classList.add('active');
                dislikeBtn.disabled = true;
                dislikeBtn.classList.remove('active');
              } else {
                dislikeBtn.classList.add('active');
                likeBtn.disabled = true;
                likeBtn.classList.remove('active');
              }
            }
            console.log("Sending vote:", action, "for idea ID:", id);
            fetch(`/ideas/vote/${id}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify({ action: action })
            })
            .then(res => res.json())
            .then(data => {
              document.getElementById(`likes-${id}`).textContent = data.likes;
              document.getElementById(`dislikes-${id}`).textContent = data.dislikes;
            });
          }
        });
      </script>

{% endblock %}

