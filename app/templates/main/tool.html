{% extends 'main/base.html' %}

{% block title %}{{ type_name | capitalize }}{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tools.css') }}">
<script>
  const isAdmin = {{ 'true' if is_admin else 'false' }};
</script>
{% endblock %}
{% block activePart1 %} {% endblock %}
{% block activePart2 %} active-part {% endblock %}
{% block activePart3 %} {% endblock %}

{% block content %}
<div class="nav">
  <a href="{{ url_for('main.index') }}">Главная > </a>
  <a href="{{ url_for('tool.open') }}"> Инструкции к ресурсам. Погружаемся в цифровые инструменты > </a>
  <a href="#">{{ section.name }}</a>
</div>
<div class="main-box">
  <br>
  <h2>Инструменты: {{ section.name }}</h2>

  <div class="tools-container">

    {% if tools %}

      {% for tool in tools %}
        <div class="one-tool-block" onclick="window.open('{{ url_for('static', filename='uploads/tools/' ~ tool.file) }}', '_blank')">
          <img src="{{ url_for('static', filename='uploads/tools/' ~ tool.photo) }}" alt="">

          <img src="{{ url_for('static', filename='uploads/tools/' ~ section.icon) }}"
     alt="icon"
     class="section-ph-one">

          <p>{{ tool.name }}</p>
                    
          {% if session.get('is_admin') %}
          <form method="POST" action="{{ url_for('tool.delete_tool', id=tool.id) }}">
              <button type="submit" class="mini-detele" onclick="event.stopPropagation();return confirm('Вы уверены, что хотите удалить этот инструмент?')">Удалить</button>
          </form>
          {% endif %}
<button class="tool-button">
  <span class="text">Смотреть файл</span>
  <span class="arrow">→</span>
</button>
        </div>
      {% endfor %}


    {% else %}
      <p>Пока нет инструментов в категории {{ type_name }}</p>
    {% endif %}

  </div>
<br>

  <div class="votes" style="justify-content: center;">
    <span style="font-size: large">Оцените раздел </span> &nbsp;
    <button class="like-btn" data-id="{{ section.id }}"><img src="{{ url_for('static', filename='images/like-new.png') }}"></button>
    <span id="likes-{{ section.id }}">{{ section.likes or 0 }}</span> &nbsp;
    <button class="dislike-btn" data-id="{{ section.id }}"><img src="{{ url_for('static', filename='images/like-new.png') }}"></button>
    <span id="dislikes-{{ section.id }}">{{ section.dislikes or 0 }}</span>
  </div>

  <hr>


  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const userVotes = {}; // храним голоса по id идеи: 'like', 'dislike' или null

      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener('click', (event) => {
          event.stopPropagation();
          const id = btn.dataset.id;
          handleVote(id, 'like', btn);
        });
      });

      document.querySelectorAll('.dislike-btn').forEach(btn => {
        btn.addEventListener('click', (event) => {
          event.stopPropagation();
          const id = btn.dataset.id;
          handleVote(id, 'dislike', btn);
        });
      });

      function handleVote(id, type, btn) {
        const likeBtn = document.querySelector(`.like-btn[data-id="${id}"]`);
        const dislikeBtn = document.querySelector(`.dislike-btn[data-id="${id}"]`);

        const currentVote = userVotes[id] || null;

        let action = null;

        if (currentVote === type) {
          // снимаем голос
          userVotes[id] = null;
          action = `un${type}`; // 'unlike' или 'undislike'
          btn.classList.remove('active');
          if (type === 'like') {
            dislikeBtn.disabled = false;
          } else {
            likeBtn.disabled = false;
          }
        } else {
          // ставим голос
          userVotes[id] = type;
          action = type;
          if (type === 'like') {
            likeBtn.classList.add('active');
            dislikeBtn.disabled = true;
            dislikeBtn.classList.remove('active');
          } else {
            dislikeBtn.classList.add('active');
            likeBtn.disabled = true;
            likeBtn.classList.remove('active');
          }
        }

        fetch(`/tools/vote/${id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({ action: action })
        })
        .then(res => res.json())
        .then(data => {
          document.getElementById(`likes-${id}`).textContent = data.likes;
          document.getElementById(`dislikes-${id}`).textContent = data.dislikes;
        });
      }
    });
  </script>


  <h1 style="margin-bottom: 0px;">Комментарии</h1>
<p style="text-align: center;margin-top: 10px; font-weight:200">Обменяемся мнениями и предложениями</p>
</div>


      <div class="comments-wrapper">
        <div class="comments-layout">

          <!-- Левая колонка: форма комментария -->


          <!-- Правая колонка: список комментариев -->

          <div class="comments-list">

            {% for comment in comments %}
            <div class="comment">
              <div class="comment-author">
                <span>{{ comment.name }}</span>
              
                <span class="comment-date">{{ comment.date.strftime('%d.%m.%Y') }}</span>
                <span class="comment-content">{{ comment.text }}</span>
                
              </div>

              {% if session.get('is_admin') %}
                <form method="POST" action="{{ url_for('idea.delete_comment', id=comment.id) }}">
                  <button type="submit" class="mini-detele" onclick="return confirm('Удалить комментарий?')">Удалить</button>
                </form>
              {% endif %}
            </div>
              {% endfor %}

              
      </div>
                <div class="comments-box" id="comments">
            <h3>Поделитесь своей идеей или мнением </h3>
            <form id="comment-form" method="post">
              <div class="form-group">

                <input id="name" type="text" name="name" placeholder="Имя" required>
              </div>

              <div class="form-group">

                <textarea id="comment" name="comment" rows="3" placeholder="Текст сообщения" required></textarea>
              </div>

              <button type="submit" class="submit-btn">Отправить</button>
            </form>

            <p>Запрещено создание сообщений, содержащих: заведомо ложную информацию, нецензурные выражения, рекламную информацию и любую информацию, нарушающую законодательство Российской Федерации. <br>
Воздержитесь от личной переписки с участниками дискуссии, неинтересной остальным её участникам. <br>
Проект отличается уважением друг к другу. <br>
Не нарушайте эту традицию.</p>
          </div>
    </div>
  </div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('comment-form');
    const objectType = form.dataset.objectType;
    const objectId = form.dataset.objectId;

    // Получаем базовый URL для удаления комментария без ID
    const deleteCommentUrlBase = "{{ url_for('tool.delete_comment', id=0) }}"; // временный id=0

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const text = document.getElementById('comment').value.trim();

      if (!name || !text) return;

      fetch("{{ url_for('tool.add_comment_tools') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({ name, text, object_type: objectType, object_id: objectId })
      })
      .then(res => res.json())
      .then(data => {
        let deleteForm = '';
        if (isAdmin) {
          // Формируем правильный URL с ID уже в JS
          const deleteUrl = deleteCommentUrlBase.replace('0', data.id);

          deleteForm = `
            <form method="POST" action="${deleteUrl}">
              <button type="submit" class="mini-detele" onclick="return confirm('Удалить комментарий?')">Удалить</button>
            </form>
          `;
        }

        const commentHTML = `
          <div class="comment">
            <div class="comment-author">${data.name}<br></div>
            <div class="comment-text">
              <div class="comment-content">${data.text}</div>
              <div class="comment-date">${data.date}</div>
            </div>
            ${deleteForm}
          </div>
        `;
        document.querySelector('.comments-list').insertAdjacentHTML('afterbegin', commentHTML);
        form.reset();
      });
    });
  });
</script>

{% endblock %}