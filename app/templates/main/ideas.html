{% extends 'main/base.html' %}

{% block title %}
Главная страница
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ideas.css') }}">
{% endblock %}
{% block activePart1 %} active-part {% endblock %}
{% block activePart2 %} {% endblock %}
{% block activePart3 %} {% endblock %}

{% block content %}
<div class="nav">
  <a href="{{ url_for('main.index') }}">Главная > </a>
  <a href="#"> Банк образовательных практик. Вдохновляемся идеями</a>
</div>
<div class="main-box">
  <h1>Вдохновляемся идеями</h1>

  <div class="advertisement">
    <p>Простая область для временного текста (например, инструкции)</p>
  </div>

  <div class="filters-container" id="filters-container">

    <div class="filters-form">
      <!-- Фильтр по предметам -->
      <div class="filter-group">
        <label for="subject">Выберите предмет:</label>
        <div class="custom-select-wrapper">
        <select id="subject" name="subject" class="custom-select">
          <option value="">Все предметы</option>
          <option value="ИЗО">ИЗО</option>
          <option value="Музыка">Музыка</option>
          <option value="Информатика">Информатика</option>
          <option value="Математика">Математика</option>
          <option value="Физика">Физика</option>
          <option value="Биология">Биология</option>
        </select>
        </div>
      </div>

      <!-- Фильтр по областям -->
      <div class="filter-group">
        
        <label for="field">Выберите область:</label>
        <div class="custom-select-wrapper">
        <select id="field" name="field" class="custom-select">
          <option value="">Все области</option>
          <option value="Нейросети">Нейросети</option>
          <option value="Доски">Доски</option>
          <option value="Инструменты">Инструменты</option>
          <option value="Программы">Программы</option>
          <option value="Методики преподавания">Методики преподавания</option>
          <option value="Учебные материалы">Учебные материалы</option>
        </select>
        </div>
      </div>

      <!-- Кнопки управления -->
      <div class="filter-buttons">
        <button type="button" class="apply-btn">Применить</button>
        <button type="button" class="reset-btn">Сбросить</button>
      </div>
    </div>
  </div>


  {% if ideas %}
  <div id="ideas-container">
    {% for idea in ideas %}
      <div class="idea" data-id="{{ idea.id }}" data-tags="{{ idea.tags|lower }}">

        {% if idea.photo %}
        <div class="idea-photo">
          <img src="{{ url_for('static', filename='uploads/ideas/photos/' ~ idea.photo) }}" alt="Фото идеи" width="150">
        </div>
        {% endif %}

        <div class="info-idea">
          {% if session.get('is_admin') %}
            <form method="POST" action="{{ url_for('idea.delete', id=idea.id) }}">
              <button type="submit" class="mini-detele" onclick="return confirm('Удалить комментарий?')">Удалить</button>
            </form>
          {% endif %}

          <strong>{{ idea.name }}</strong>
          <p>{{ idea.description }}</p>

          <span>Теги:
            {% if idea.tags %}
              {% for tag in idea.tags.split(',') %}
                <span class="tag">#{{ tag.strip() }}</span>
              {% endfor %}
            {% else %}
              <span class="tag">Без тегов</span>
            {% endif %}
          </span>
   
          <div class="bottom-info">
          <div class="votes">
            <button class="like-btn" data-id="{{ idea.id }}"><img src="{{ url_for('static', filename='images/like-new.png') }}"></button>
            <span id="likes-{{ idea.id }}" class="votes-score">{{ idea.likes or 0 }}</span> &nbsp;
            <button class="dislike-btn" data-id="{{ idea.id }}"><img src="{{ url_for('static', filename='images/like-new.png') }}"></button>
            <span id="dislikes-{{ idea.id }}" class="votes-score">{{ idea.dislikes or 0 }}</span>
          </div>
          <a href="{{ url_for('idea.open_one', id=idea.id) }}"><button class="open-one">Узнать подробнее &nbsp; &nbsp;→</button></a>
          </div>

        </div>

      </div>

    {% endfor %}
    </div>

<div class="pagination pagination-controls">
  <form id="page-jump-form" class="pagination-form" onsubmit="return false;">
    <span id="page-info"></span>
    <span>
      Страница
      <input type="number" name="page" id="page-input" value="1" min="1" style="width: 50px;">
      из <span id="total-pages">1</span>
      <button id="go-page-btn" type="submit">OK</button>
    </span>
  </form>

  <div class="tools-buttons sliver-controlls">
    <a href="#" id="prev-page" class="prev-slider"></a>
    <a href="#" id="next-page" class="next-slider"></a>
  </div>
</div>




<script>
  document.addEventListener('DOMContentLoaded', () => {
  const ideasPerPage = 5;
  const ideasContainer = document.getElementById('ideas-container');
  const allIdeas = Array.from(ideasContainer.querySelectorAll('.idea'));

  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const pageInfo = document.getElementById('page-info');
  const pageInput = document.getElementById('page-input');
  const totalPagesSpan = document.getElementById('total-pages');
  const pageJumpForm = document.getElementById('page-jump-form');

  const subjectSelect = document.getElementById('subject');
  const fieldSelect = document.getElementById('field');
  const applyBtn = document.querySelector('.apply-btn');
  const resetBtn = document.querySelector('.reset-btn');

  let currentPage = parseInt(localStorage.getItem('currentPage') || '1', 10);
  let currentSubject = localStorage.getItem('currentSubject') || '';
  let currentField = localStorage.getItem('currentField') || '';

  // Восстанавливаем значения фильтров в select
  subjectSelect.value = currentSubject;
  fieldSelect.value = currentField;

  function scrollToFilters() {
    const filters = document.getElementById('filters-container');
    if (filters) {
      filters.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  function filterIdeas() {
    return allIdeas.filter(idea => {
      const tagsRaw = idea.dataset.tags || '';
      const tags = tagsRaw.split(',').map(t => t.trim().toLowerCase());

      let subjectMatch = !currentSubject || tags.includes(currentSubject.toLowerCase());
      let fieldMatch = !currentField || tags.includes(currentField.toLowerCase());

      return subjectMatch && fieldMatch;
    });
  }

  function showPage(page) {
    currentPage = page;
    localStorage.setItem('currentPage', currentPage); // сохраняем страницу

    const filteredIdeas = filterIdeas();
    const totalPages = Math.ceil(filteredIdeas.length / ideasPerPage) || 1;

    if (page < 1) currentPage = 1;
    else if (page > totalPages) currentPage = totalPages;

    allIdeas.forEach(idea => idea.style.display = 'none');

    const startIdx = (currentPage - 1) * ideasPerPage;
    const endIdx = startIdx + ideasPerPage;
    filteredIdeas.slice(startIdx, endIdx).forEach(idea => {
      idea.style.display = 'flex';
    });

    totalPagesSpan.textContent = totalPages;
    pageInput.value = currentPage;

    prevBtn.classList.toggle('disabled', currentPage === 1);
    nextBtn.classList.toggle('disabled', currentPage === totalPages);
  }

  prevBtn.addEventListener('click', e => {
    e.preventDefault();
    if (currentPage > 1) showPage(currentPage - 1);
    scrollToFilters();
  });

  nextBtn.addEventListener('click', e => {
    e.preventDefault();
    const totalPages = Math.ceil(filterIdeas().length / ideasPerPage) || 1;
    if (currentPage < totalPages) showPage(currentPage + 1);
    scrollToFilters();
  });

  pageJumpForm.addEventListener('submit', e => {
    e.preventDefault();
    let requestedPage = parseInt(pageInput.value, 10);
    if (isNaN(requestedPage)) requestedPage = 1;
    showPage(requestedPage);
    scrollToFilters();
  });

  applyBtn.addEventListener('click', () => {
    currentSubject = subjectSelect.value;
    currentField = fieldSelect.value;
    localStorage.setItem('currentSubject', currentSubject);
    localStorage.setItem('currentField', currentField);
    showPage(1);
  });

  resetBtn.addEventListener('click', () => {
    subjectSelect.value = '';
    fieldSelect.value = '';
    currentSubject = '';
    currentField = '';
    localStorage.setItem('currentSubject', '');
    localStorage.setItem('currentField', '');
    showPage(1);
  });

  // при загрузке сразу показываем нужную страницу
  showPage(currentPage);
});
// document.addEventListener('DOMContentLoaded', () => {
//   const ideasPerPage = 5;
//   const ideasContainer = document.getElementById('ideas-container');
//   const allIdeas = Array.from(ideasContainer.querySelectorAll('.idea'));

//   const prevBtn = document.getElementById('prev-page');
//   const nextBtn = document.getElementById('next-page');
//   const pageInfo = document.getElementById('page-info');
//   const pageInput = document.getElementById('page-input');
//   const totalPagesSpan = document.getElementById('total-pages');
//   const pageJumpForm = document.getElementById('page-jump-form');

//   const subjectSelect = document.getElementById('subject');
//   const fieldSelect = document.getElementById('field');
//   const applyBtn = document.querySelector('.apply-btn');
//   const resetBtn = document.querySelector('.reset-btn');

//   let currentPage = 1;
//   let currentSubject = '';
//   let currentField = '';

//   function scrollToFilters() {
//     const filters = document.getElementById('filters-container');
//     if (filters) {
//       filters.scrollIntoView({ behavior: 'smooth', block: 'start' });
//     }
//   }


//   function filterIdeas() {
//     return allIdeas.filter(idea => {
//       const tagsRaw = idea.dataset.tags || '';
//       const tags = tagsRaw.split(',').map(t => t.trim().toLowerCase());

//       let subjectMatch = true;
//       let fieldMatch = true;

//       if (currentSubject) {
//         subjectMatch = tags.includes(currentSubject.toLowerCase());
//       }
//       if (currentField) {
//         fieldMatch = tags.includes(currentField.toLowerCase());
//       }

//       return subjectMatch && fieldMatch;
//     });
//   }

//   function showPage(page) {
//     currentPage = page;

//     const filteredIdeas = filterIdeas();
//     const totalPages = Math.ceil(filteredIdeas.length / ideasPerPage) || 1;

//     if (page < 1) currentPage = 1;
//     else if (page > totalPages) currentPage = totalPages;

//     // Скрываем все идеи
//     allIdeas.forEach(idea => idea.style.display = 'none');

//     // Показываем только идеи с текущей страницы после фильтрации
//     const startIdx = (currentPage - 1) * ideasPerPage;
//     const endIdx = startIdx + ideasPerPage;
//     filteredIdeas.slice(startIdx, endIdx).forEach(idea => {
//       idea.style.display = 'flex';
//     });

//     pageInfo.textContent = ``;
//     totalPagesSpan.textContent = totalPages;
//     pageInput.value = currentPage;

//     prevBtn.classList.toggle('disabled', currentPage === 1);
//     nextBtn.classList.toggle('disabled', currentPage === totalPages);
//   }

//   prevBtn.addEventListener('click', e => {
//     e.preventDefault();
//     if (currentPage > 1) showPage(currentPage - 1);
//     scrollToFilters();
//   });

//   nextBtn.addEventListener('click', e => {
//     e.preventDefault();
//     const filteredIdeas = filterIdeas();
//     const totalPages = Math.ceil(filteredIdeas.length / ideasPerPage) || 1;
//     if (currentPage < totalPages) showPage(currentPage + 1);
//     scrollToFilters();
//   });

//   pageJumpForm.addEventListener('submit', e => {
//     e.preventDefault();
//     let requestedPage = parseInt(pageInput.value, 10);
//     if (isNaN(requestedPage)) requestedPage = 1;
//     showPage(requestedPage);
//     scrollToFilters();
//   });

//   applyBtn.addEventListener('click', () => {
//     currentSubject = subjectSelect.value;
//     currentField = fieldSelect.value;
//     showPage(1);
//   });

//   resetBtn.addEventListener('click', () => {
//     subjectSelect.value = '';
//     fieldSelect.value = '';
//     currentSubject = '';
//     currentField = '';
//     showPage(1);
//   });

//   showPage(1);
// });  
</script>


      {% else %}
        <p>Идей пока нет.</p>
      {% endif %}

      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const userVotes = {}; // храним голоса по id идеи: 'like', 'dislike' или null

          document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
              event.stopPropagation();
              const id = btn.dataset.id;
              handleVote(id, 'like', btn);
            });
          });

          document.querySelectorAll('.dislike-btn').forEach(btn => {
            btn.addEventListener('click', (event) => {
              event.stopPropagation();
              const id = btn.dataset.id;
              handleVote(id, 'dislike', btn);
            });
          });

          function handleVote(id, type, btn) {
            const likeBtn = document.querySelector(`.like-btn[data-id="${id}"]`);
            const dislikeBtn = document.querySelector(`.dislike-btn[data-id="${id}"]`);

            const currentVote = userVotes[id] || null;

            let action = null;

            if (currentVote === type) {
              // снимаем голос
              userVotes[id] = null;
              action = `un${type}`; // 'unlike' или 'undislike'
              btn.classList.remove('active');
              if (type === 'like') {
                dislikeBtn.disabled = false;
              } else {
                likeBtn.disabled = false;
              }
            } else {
              // ставим голос
              userVotes[id] = type;
              action = type;
              if (type === 'like') {
                likeBtn.classList.add('active');
                dislikeBtn.disabled = true;
                dislikeBtn.classList.remove('active');
              } else {
                dislikeBtn.classList.add('active');
                likeBtn.disabled = true;
                likeBtn.classList.remove('active');
              }
            }

            fetch(`/ideas/vote/${id}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify({ action: action })
            })
            .then(res => res.json())
            .then(data => {
              document.getElementById(`likes-${id}`).textContent = data.likes;
              document.getElementById(`dislikes-${id}`).textContent = data.dislikes;
            });
          }
        });
      </script>

      <script>
        window.addEventListener("pageshow", function (event) {
          if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
            // Если это переход назад — перезагружаем страницу
            window.location.reload();
          }
        });
      </script>
      


  <h1 style="margin-bottom: 0px;">Комментарии</h1>
<p style="text-align: center;margin-top: 10px; font-weight:200">Обменяемся мнениями и предложениями</p>
</div>


      <div class="comments-wrapper">
        <div class="comments-layout">

          <!-- Левая колонка: форма комментария -->


          <!-- Правая колонка: список комментариев -->

          <div class="comments-list">

            {% for comment in comments %}
            <div class="comment">
              <div class="comment-author">
                <span>{{ comment.name }}</span>
              
                <span class="comment-date">{{ comment.date.strftime('%d.%m.%Y') }}</span>
                <span class="comment-content">{{ comment.text }}</span>
                
              </div>

              {% if session.get('is_admin') %}
                <form method="POST" action="{{ url_for('idea.delete_comment', id=comment.id) }}">
                  <button type="submit" class="mini-detele" onclick="return confirm('Удалить комментарий?')">Удалить</button>
                </form>
              {% endif %}
            </div>
              {% endfor %}

              
      </div>
                <div class="comments-box" id="comments">
            <h3>Поделитесь своей идеей или мнением </h3>
            <form id="comment-form" method="post">
              <div class="form-group">

                <input id="name" type="text" name="name" placeholder="Имя" required>
              </div>

              <div class="form-group">

                <textarea id="comment" name="comment" rows="3" placeholder="Текст сообщения" required></textarea>
              </div>

              <button type="submit" class="submit-btn">Отправить</button>
            </form>

            <p>Запрещено создание сообщений, содержащих: заведомо ложную информацию, нецензурные выражения, рекламную информацию и любую информацию, нарушающую законодательство Российской Федерации. <br>
Воздержитесь от личной переписки с участниками дискуссии, неинтересной остальным её участникам. <br>
Проект отличается уважением друг к другу. <br>
Не нарушайте эту традицию.</p>
          </div>
    </div>
  </div>



<script>
  const deleteCommentUrlBase = "/ideas/comment/delete/__id__";

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('comment-form');
    const isAdmin = {{ 'true' if session.get('is_admin') else 'false' }};

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const text = document.getElementById('comment').value.trim();

      if (!name || !text) return;

      fetch("{{ url_for('idea.add_comment') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({ name, text })
      })
      .then(res => res.json())
      .then(data => {
        let deleteForm = '';
        if (isAdmin) {
          const deleteUrl = deleteCommentUrlBase.replace('__id__', data.id.toString());
          deleteForm = `
            <form method="POST" action="${deleteUrl}">
              <button type="submit" class="mini-detele" onclick="return confirm('Удалить комментарий?')">Удалить</button>
            </form>
          `;
        }

        const commentHTML = `
          <div class="comment">
            <div class="comment-author">
              <span>${data.name}</span>
              <span>${data.date}</span>
              <span>${data.text}</span>
            ${deleteForm}
          </div>
        `;
        document.querySelector('.comments-list').insertAdjacentHTML('afterbegin', commentHTML);
        form.reset();
      })
      .catch(error => console.error('Fetch error:', error));
    });
  });
</script>

<script>
document.querySelector(".apply-btn").addEventListener("click", () => {
  const ideas = document.querySelectorAll(".idea");

  const tagMap = {
    art: "изо",
    music: "музыка",
    informatics: "информатика",
    math: "математика",
    physics: "физика",
    biology: "биология",
    neural: "нейросети",
    boards: "доски",
    tools: "инструменты",
    programs: "программы",
    methodics: "методики преподавания",
    materials: "учебные материалы"
  };

  const subjectValue = document.getElementById("subject").value;
  const fieldValue = document.getElementById("field").value;

  // собираем выбранные теги
  const selectedTags = [];
  if (subjectValue && tagMap[subjectValue]) {
    selectedTags.push(tagMap[subjectValue]);
  }
  if (fieldValue && tagMap[fieldValue]) {
    selectedTags.push(tagMap[fieldValue]);
  }

  ideas.forEach(idea => {
    const ideaTagsRaw = idea.dataset.tags || "";
    const ideaTags = ideaTagsRaw.toLowerCase();

    // если фильтры не выбраны — показываем всё
    if (selectedTags.length === 0) {
      idea.style.display = "flex";
      return;
    }

    // строгая проверка: все выбранные теги должны быть в data-tags
    const allMatch = selectedTags.every(tag =>
      ideaTags.includes(tag)
    );

    idea.style.display = allMatch ? "flex" : "none";
  });
});

// Сброс фильтра
document.querySelector(".reset-btn").addEventListener("click", () => {
  document.getElementById("subject").value = "";
  document.getElementById("field").value = "";

  document.querySelectorAll(".idea").forEach(idea => {
    idea.style.display = "flex";
  });
});
</script>


<br>
{% endblock %}